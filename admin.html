import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

let db, auth;

document.addEventListener('DOMContentLoaded', () => {
    const mainContent = document.getElementById('main-content');
    const passwordOverlay = document.getElementById('password-overlay');
    const passwordForm = document.getElementById('password-form');
    const passwordInput = document.getElementById('password');
    const passwordError = document.getElementById('password-error');

    passwordForm.addEventListener('submit', (e) => {
        e.preventDefault();
        if (passwordInput.value === 'nilam') {
            passwordOverlay.style.display = 'none';
            mainContent.style.display = 'block';
            startApp();
        } else {
            passwordError.textContent = 'Incorrect password.';
            setTimeout(() => passwordError.textContent = '', 2000);
        }
    });
});

function getServerConfig() {
    return new Promise((resolve, reject) => {
        let attempts = 0, maxAttempts = 300; // Wait up to 30 seconds
        const interval = setInterval(() => {
            if (typeof __firebase_config !== 'undefined' && __firebase_config && typeof __app_id !== 'undefined' && __app_id) {
                clearInterval(interval);
                resolve({
                    firebaseConfig: JSON.parse(__firebase_config),
                    appId: __app_id
                });
            } else if (++attempts >= maxAttempts) {
                clearInterval(interval);
                reject(new Error("Server configuration timed out. Please refresh."));
            }
        }, 100);
    });
}

async function startApp() {
    const messageDiv = document.getElementById('form-message');
    const submitButton = document.getElementById('submit-button');
    const loadingArticles = document.getElementById('loading-articles');

    submitButton.disabled = true;
    submitButton.textContent = 'Waiting for Server...';
    loadingArticles.textContent = 'Waiting for Server Configuration...';

    try {
        const config = await getServerConfig();
        const app = initializeApp(config.firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        
        initializeAppAndAuth(config.appId);

    } catch (error) {
        console.error(error.message);
        messageDiv.textContent = `Error: ${error.message}`;
        messageDiv.className = 'text-red-600';
        submitButton.textContent = 'Connection Failed';
        loadingArticles.textContent = 'Could not connect to database.';
    }
}

function initializeAppAndAuth(appId) {
    const submitButton = document.getElementById('submit-button');
    const messageDiv = document.getElementById('form-message');

    submitButton.textContent = 'Authenticating...';

    onAuthStateChanged(auth, user => {
         if (user) {
            submitButton.disabled = false;
            submitButton.textContent = 'Publish Article';
            setupFormListeners(appId);
            displayPublishedNews(appId);
        }
    });
    
    const authenticate = async () => {
        try {
            if (!auth.currentUser) {
                 if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            }
        } catch (error) {
            console.error("Authentication failed:", error);
            submitButton.textContent = 'Authentication Failed';
            messageDiv.textContent = `Error: Auth failed. (${error.message})`;
        }
    };
    
    if (!auth.currentUser) {
        authenticate();
    } else {
       submitButton.disabled = false;
       submitButton.textContent = 'Publish Article';
       setupFormListeners(appId);
       displayPublishedNews(appId);
    }
}

function setupFormListeners(appId) {
    const form = document.getElementById('add-news-form');
    const messageDiv = document.getElementById('form-message');
    const submitButton = document.getElementById('submit-button');
    const articlesCollection = collection(db, `/artifacts/${appId}/public/data/articles`);

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!auth.currentUser) {
            messageDiv.textContent = 'Error: Not authenticated.'; return;
        }
        submitButton.disabled = true;
        submitButton.textContent = 'Publishing...';
        
        const articleData = {
            title: document.getElementById('title').value,
            imageUrl: document.getElementById('imageUrl').value,
            category: document.getElementById('category').value,
            content: document.getElementById('content').value,
            createdAt: serverTimestamp()
        };

        try {
            await addDoc(articlesCollection, articleData);
            messageDiv.textContent = 'Article published successfully!';
            messageDiv.className = 'text-green-600';
            form.reset();
        } catch (error) {
            console.error("Error adding document: ", error);
            messageDiv.textContent = `Error: Could not publish. (${error.message})`;
            messageDiv.className = 'text-red-600';
        } finally {
            submitButton.disabled = false;
            submitButton.textContent = 'Publish Article';
            setTimeout(() => messageDiv.textContent = '', 3000);
        }
    });
}

function displayPublishedNews(appId) {
    const container = document.getElementById('published-news');
    const loadingP = document.getElementById('loading-articles');
    const articlesCollection = collection(db, `/artifacts/${appId}/public/data/articles`);

    onSnapshot(articlesCollection, (snapshot) => {
        if (snapshot.empty) {
            loadingP.textContent = 'No articles published yet.';
            loadingP.style.display = 'block';
            container.innerHTML = '';
        } else {
            loadingP.style.display = 'none';
            container.innerHTML = '';
            const articles = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            articles.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));

            articles.forEach(article => {
                const pubDate = article.createdAt ? article.createdAt.toDate().toLocaleDateString('en-US') : 'N/A';
                const articleEl = document.createElement('div');
                articleEl.className = 'p-4 border rounded-md flex items-center justify-between';
                articleEl.innerHTML = `
                    <div>
                        <h3 class="font-bold text-gray-900">${article.title}</h3>
                        <p class="text-sm text-gray-500">${article.category} - ${pubDate}</p>
                    </div>
                    <button data-id="${article.id}" class="delete-btn text-red-500 hover:text-red-700 font-semibold">Delete</button>
                `;
                container.appendChild(articleEl);
            });

            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const id = e.target.dataset.id;
                    if (confirm('Are you sure you want to delete this article?')) {
                        try {
                            await deleteDoc(doc(db, `/artifacts/${appId}/public/data/articles`, id));
                        } catch (error) {
                            console.error("Error deleting document: ", error);
                            alert("Could not delete article.");
                        }
                    }
                });
            });
        }
    }, (error) => {
         console.error("Error fetching articles:", error);
         loadingP.textContent = 'Could not load published articles.';
    });
}
